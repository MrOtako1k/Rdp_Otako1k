name: Infinite RDP Server

on:
  workflow_dispatch:
    inputs:
      idle_timeout:
        description: 'Auto shutdown after X minutes of inactivity'
        required: false
        default: '240'
        type: number
      reset_every_hours:
        description: 'Automatically reset every X hours (0 to disable)'
        required: false
        default: '12'
        type: number
      install_tools:
        description: 'Install development tools'
        required: false
        default: true
        type: boolean
      enable_ssh:
        description: 'Enable SSH access via Tailscale'
        required: false
        default: true
        type: boolean

env:
  RDP_USERNAME: "GitHubRDP"
  SESSION_ID: ${{ github.run_id }}-${{ github.run_attempt }}
  HOSTNAME: "gh-rdp-${{ github.run_id }}-${{ github.run_attempt }}"

jobs:
  infinite-rdp:
    runs-on: windows-latest
    
    # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù„Ù„Ø¹Ù…Ù„ÙŠØ© Ù„ØªÙƒÙˆÙ† Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ©
    timeout-minutes: 0
    
    steps:
      - name: Initialize Session
        run: |
          Write-Host "=== INFINITE RDP SESSION ==="
          Write-Host "Session ID: $env:SESSION_ID"
          Write-Host "Hostname: $env:HOSTNAME"
          Write-Host "Started at: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          Write-Host "==========================="
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ù„Ù„Ø¬Ù„Ø³Ø©
          New-Item -ItemType Directory -Path "C:\RDP-Session" -Force | Out-Null
          
          # ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø¯Ø¡
          $sessionInfo = @{
            StartTime = Get-Date
            SessionID = $env:SESSION_ID
            Hostname = $env:HOSTNAME
            Runner = $env:RUNNER_NAME
          } | ConvertTo-Json
          
          Set-Content -Path "C:\RDP-Session\session-info.json" -Value $sessionInfo

      - name: Configure Windows for RDP
        run: |
          # ØªÙ…ÙƒÙŠÙ† RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          
          # Ø¶Ø¨Ø· Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ù…Ø§Ù† Ù…ØªÙ‚Ø¯Ù…Ø©
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "SecurityLayer" -Value 2 -Force
          
          # Ø²ÙŠØ§Ø¯Ø© ÙˆÙ‚Øª Ø§Ù„Ù…Ù‡Ù„Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "MaxIdleTime" -Value 86400000  # 24 Ø³Ø§Ø¹Ø©
          
          # ØªØ¹Ø·ÙŠÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ø·Ø§Ø¨Ø¹Ø© (ØªÙˆÙÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø±Ø¯)
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' `
                           -Name "fDisableCpm" -Value 1 -Force -ErrorAction SilentlyContinue

      - name: Create Persistent User Account
        id: create_user
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©
          function Generate-Password {
              param([int]$Length = 20)
              $charSet = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*'.ToCharArray()
              $rng = [System.Security.Cryptography.RandomNumberGenerator]::Create()
              $bytes = New-Object byte[] $Length
              $rng.GetBytes($bytes)
              $password = -join ($bytes | ForEach-Object { $charSet[$_ % $charSet.Length] })
              $rng.Dispose()
              return $password
          }
          
          $password = Generate-Password -Length 24
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
          $userExists = Get-LocalUser -Name $env:RDP_USERNAME -ErrorAction SilentlyContinue
          
          if (-not $userExists) {
              $securePass = ConvertTo-SecureString $password -AsPlainText -Force
              New-LocalUser -Name $env:RDP_USERNAME -Password $securePass -PasswordNeverExpires
              Write-Host "Created new user: $env:RDP_USERNAME"
          } else {
              # Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
              $securePass = ConvertTo-SecureString $password -AsPlainText -Force
              Set-LocalUser -Name $env:RDP_USERNAME -Password $securePass
              Write-Host "Reset password for existing user: $env:RDP_USERNAME"
          }
          
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
          Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USERNAME -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USERNAME -ErrorAction SilentlyContinue
          
          # ØªØ®Ø²ÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          echo "::add-mask::$password"
          
          # Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ù…Ù„Ù Ù…Ø¤Ù‚Øª (Ù„Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹)
          $creds = @{
              Username = $env:RDP_USERNAME
              Password = $password
              Generated = (Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          } | ConvertTo-Json
          
          Set-Content -Path "C:\RDP-Session\credentials.json" -Value $creds -Encoding UTF8

      - name: Configure Firewall Rules
        run: |
          # Ø­Ø°Ù Ø£ÙŠ Ù‚ÙˆØ§Ø¹Ø¯ Ù‚Ø¯ÙŠÙ…Ø©
          netsh advfirewall firewall delete rule name="GitHub-RDP-Infinite" 2>$null
          netsh advfirewall firewall delete rule name="GitHub-SSH-Infinite" 2>$null
          
          # Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ RDP Ø¹Ø¨Ø± Tailscale ÙÙ‚Ø·
          netsh advfirewall firewall add rule name="GitHub-RDP-Infinite" `
            dir=in action=allow protocol=TCP localport=3389 `
            remoteip=100.64.0.0/10  # Ù†Ø·Ø§Ù‚ Tailscale
          
          # Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ SSH Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„Ø§Ù‹
          if ("${{ github.event.inputs.enable_ssh }}" -eq "true") {
              netsh advfirewall firewall add rule name="GitHub-SSH-Infinite" `
                dir=in action=allow protocol=TCP localport=22 `
                remoteip=100.64.0.0/10
          }
          
          # Ù…Ù†Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ù…Ù†ÙØ° RDP
          netsh advfirewall firewall add rule name="Block-Public-RDP" `
            dir=in action=block protocol=TCP localport=3389 `
            remoteip=any

      - name: Install and Setup Tailscale
        run: |
          # ØªØ«Ø¨ÙŠØª Tailscale
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale-infinite.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force
          
          # Ø§Ù†ØªØ¸Ø§Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„Ø®Ø¯Ù…Ø©
          Start-Sleep -Seconds 10
          
          # Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø´Ø¨ÙƒØ© Tailscale
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --hostname=$env:HOSTNAME `
            --accept-routes `
            --accept-dns=false `
            --reset
          
          # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† IP
          $maxRetries = 10
          $retryCount = 0
          $tailscaleIP = $null
          
          while ($retryCount -lt $maxRetries -and -not $tailscaleIP) {
              Start-Sleep -Seconds 5
              $tailscaleIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
              $retryCount++
          }
          
          if (-not $tailscaleIP) {
              Write-Error "Failed to get Tailscale IP after $maxRetries attempts"
              exit 1
          }
          
          echo "TAILSCALE_IP=$tailscaleIP" >> $env:GITHUB_ENV
          
          # Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©
          $networkInfo = @{
              TailscaleIP = $tailscaleIP
              TailscaleStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json | ConvertFrom-Json
              Timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
          } | ConvertTo-Json
          
          Set-Content -Path "C:\RDP-Session\network-info.json" -Value $networkInfo

      - name: Install Development Tools (Optional)
        if: ${{ github.event.inputs.install_tools }}
        run: |
          Write-Host "Installing development tools..."
          
          # ØªØ«Ø¨ÙŠØª Chocolatey Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø«Ø¨ØªØ§Ù‹
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
              Set-ExecutionPolicy Bypass -Scope Process -Force
              [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
              iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          }
          
          # Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ù„Ù„ØªØ«Ø¨ÙŠØª
          $tools = @(
              "git",
              "curl",
              "wget",
              "7zip",
              "vscode",
              "python",
              "nodejs-lts",
              "docker-desktop",
              "sysinternals",
              "powershell-core",
              "googlechrome",
              "firefox"
          )
          
          foreach ($tool in $tools) {
              try {
                  choco install $tool -y --no-progress
                  Write-Host "âœ“ Installed: $tool"
              } catch {
                  Write-Warning "Failed to install: $tool"
              }
          }
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨
          $desktopPath = [Environment]::GetFolderPath("Desktop")
          $shortcuts = @(
              @{Name="Terminal.lnk"; Target="wt.exe"; Arguments=""; Icon="%SystemRoot%\System32\cmd.exe"},
              @{Name="PowerShell.lnk"; Target="pwsh.exe"; Arguments="-NoExit"; Icon="%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe"},
              @{Name="VS Code.lnk"; Target="code.exe"; Arguments=""; Icon="%ProgramFiles%\Microsoft VS Code\Code.exe"}
          )
          
          foreach ($shortcut in $shortcuts) {
              $shell = New-Object -ComObject WScript.Shell
              $link = $shell.CreateShortcut("$desktopPath\$($shortcut.Name)")
              $link.TargetPath = $shortcut.Target
              $link.Arguments = $shortcut.Arguments
              $link.IconLocation = $shortcut.Icon
              $link.Save()
          }

      - name: Setup SSH Server (Optional)
        if: ${{ github.event.inputs.enable_ssh }}
        run: |
          Write-Host "Setting up SSH server..."
          
          # ØªØ«Ø¨ÙŠØª OpenSSH Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø«Ø¨ØªØ§Ù‹
          Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
          
          # ØªÙƒÙˆÙŠÙ† SSH
          Start-Service sshd
          Set-Service -Name sshd -StartupType 'Automatic'
          
          # Ø§Ù„Ø³Ù…Ø§Ø­ Ù„ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Root Ø¹Ø¨Ø± SSH
          $sshdConfigPath = "$env:ProgramData\ssh\sshd_config"
          $config = Get-Content $sshdConfigPath
          $config = $config -replace '#?PasswordAuthentication no', 'PasswordAuthentication yes'
          $config = $config -replace '#?PermitRootLogin no', 'PermitRootLogin yes'
          Set-Content -Path $sshdConfigPath -Value $config
          
          # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø®Ø¯Ù…Ø© SSH
          Restart-Service sshd
          
          Write-Host "SSH Server configured on port 22"

      - name: Create Maintenance Scripts
        run: |
          # Ø³ÙƒØ±ÙŠØ¨Øª Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
          $resetScript = @'
          # Auto-reset password script
          $newPassword = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 20 | % {[char]$_})
          $securePass = ConvertTo-SecureString $newPassword -AsPlainText -Force
          Set-LocalUser -Name "$env:RDP_USERNAME" -Password $securePass
          
          # Update credentials file
          $creds = @{
              Username = "$env:RDP_USERNAME"
              Password = $newPassword
              ResetTime = (Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          } | ConvertTo-Json
          
          Set-Content -Path "C:\RDP-Session\credentials.json" -Value $creds -Encoding UTF8
          Write-Host "Password reset at: $(Get-Date -Format 'HH:mm:ss')"
'@
          
          Set-Content -Path "C:\RDP-Session\reset-password.ps1" -Value $resetScript
          
          # Ø³ÙƒØ±ÙŠØ¨Øª Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬Ù„Ø³Ø©
          $monitorScript = @'
          # Session monitor script
          while ($true) {
              $activeSessions = (qwinsta | Where-Object { $_ -match 'Active' }).Count
              $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
              $uptime = (Get-Date) - (Get-Content "C:\RDP-Session\session-info.json" | ConvertFrom-Json).StartTime | Select-Object Days, Hours, Minutes
              
              $status = @{
                  Timestamp = $timestamp
                  ActiveSessions = $activeSessions
                  Uptime = "$($uptime.Days)d $($uptime.Hours)h $($uptime.Minutes)m"
                  CPU = (Get-CimInstance Win32_Processor | Measure-Object -Property LoadPercentage -Average).Average
                  Memory = (Get-CimInstance Win32_OperatingSystem | ForEach-Object { 
                      "{0:N1}%" -f ((($_.TotalVisibleMemorySize - $_.FreePhysicalMemory) * 100) / $_.TotalVisibleMemorySize) 
                  })
              }
              
              $status | ConvertTo-Json | Add-Content -Path "C:\RDP-Session\session-status.log"
              Start-Sleep -Seconds 60
          }
'@
          
          Set-Content -Path "C:\RDP-Session\monitor-session.ps1" -Value $monitorScript
          
          # Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
          Start-Process powershell.exe -ArgumentList "-File", "C:\RDP-Session\monitor-session.ps1" -WindowStyle Hidden

      - name: Display Connection Information
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¬Ù…ÙŠÙ„Ø©
          $border = "=" * 70
          $title = "INFINITE RDP SESSION"
          
          $info = @"
          $border
          $title
          $border
          
          ğŸ“ Connection Information:
          =========================
          Hostname:      $env:HOSTNAME
          IP Address:    $env:TAILSCALE_IP
          Username:      $env:RDP_USERNAME
          Password:      $env:RDP_PASSWORD
          
          ğŸŒ Network Access:
          =================
          RDP Port:      3389 (via Tailscale only)
          SSH Port:      22 (if enabled)
          
          âš™ï¸ Session Details:
          ==================
          Session ID:    $env:SESSION_ID
          Start Time:    $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          Status:        ACTIVE âœ“
          
          ğŸ”— Quick Connect:
          ================
          1. Connect to Tailscale VPN
          2. Open Remote Desktop Connection
          3. Enter: $env:TAILSCALE_IP
          4. Username: $env:RDP_USERNAME
          
          âš ï¸ Important Notes:
          ==================
          â€¢ Session will remain active indefinitely
          â€¢ Monitor GitHub Actions for auto-shutdown
          â€¢ Password can be reset if needed
          
          $border
"@
          
          Write-Host $info
          
          # Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ù…Ù„Ù
          Set-Content -Path "C:\RDP-Session\connection-info.txt" -Value $info
          
          # Ø¹Ø±Ø¶ QR Code Ù„Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
          $rdpFileContent = @"
full address:s:$env:TAILSCALE_IP
username:s:$env:RDP_USERNAME
"@
          
          Set-Content -Path "C:\RDP-Session\connection.rdp" -Value $rdpFileContent
          Write-Host "RDP connection file saved to: C:\RDP-Session\connection.rdp"

      - name: Infinite Session Maintenance Loop
        run: |
          # ØªÙ‡ÙŠØ¦Ø© Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
          $sessionStart = Get-Date
          $lastActivity = Get-Date
          $resetInterval = ${{ github.event.inputs.reset_every_hours }} * 3600  # ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø«ÙˆØ§Ù†ÙŠ
          $idleTimeout = ${{ github.event.inputs.idle_timeout }} * 60  # ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø«ÙˆØ§Ù†ÙŠ
          $resetCounter = 0
          
          Write-Host "`nğŸ”„ Entering infinite maintenance loop..."
          Write-Host "Auto-reset every: ${{ github.event.inputs.reset_every_hours }} hours"
          Write-Host "Idle timeout: ${{ github.event.inputs.idle_timeout }} minutes"
          Write-Host "Press Ctrl+C in GitHub UI to stop session`n"
          
          # Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠØ©
          while ($true) {
              $currentTime = Get-Date
              $uptime = $currentTime - $sessionStart
              
              # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø´Ø§Ø·
              $activeSessions = (qwinsta | Where-Object { $_ -match 'Active' }).Count
              
              if ($activeSessions -gt 0) {
                  $lastActivity = $currentTime
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Active sessions: $activeSessions"
              }
              
              # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù‡Ù„Ø© Ø§Ù„Ø®Ù…ÙˆÙ„
              $idleTime = ($currentTime - $lastActivity).TotalSeconds
              if ($idleTimeout -gt 0 -and $idleTime -gt $idleTimeout) {
                  Write-Host "â° Idle timeout reached ($idleTimeout seconds). Shutting down..."
                  break
              }
              
              # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¯ÙˆØ±ÙŠØ©
              if ($resetInterval -gt 0 -and $uptime.TotalSeconds -gt $resetInterval) {
                  $resetCounter++
                  Write-Host "ğŸ”„ Performing scheduled reset #$resetCounter..."
                  
                  # Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                  powershell.exe -File "C:\RDP-Session\reset-password.ps1"
                  
                  # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø®Ø¯Ù…Ø© RDP
                  Restart-Service TermService -Force
                  
                  $sessionStart = Get-Date
                  Write-Host "Reset completed at $(Get-Date -Format 'HH:mm:ss')"
              }
              
              # ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
              $cpuUsage = (Get-CimInstance Win32_Processor | Measure-Object -Property LoadPercentage -Average).Average
              $memoryUsage = (Get-CimInstance Win32_OperatingSystem | ForEach-Object { 
                  [math]::Round((($_.TotalVisibleMemorySize - $_.FreePhysicalMemory) * 100) / $_.TotalVisibleMemorySize, 1)
              })
              
              # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
              if ((Get-Date).Minute % 5 -eq 0) {
                  $status = @{
                      Timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
                      Uptime = "$([math]::Floor($uptime.TotalHours))h $([math]::Floor($uptime.Minutes))m"
                      ActiveSessions = $activeSessions
                      CPU = "$cpuUsage%"
                      Memory = "$memoryUsage%"
                      IdleTime = "$([math]::Floor($idleTime / 60))m"
                  }
                  
                  Write-Host "[STATUS] $($status | ConvertTo-Json -Compress)"
              }
              
              # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠ
              Start-Sleep -Seconds 30
          }
          
          Write-Host "Session ending..."
          
      - name: Cleanup on Exit
        if: always()
        run: |
          Write-Host "ğŸ”„ Performing cleanup..."
          
          # Ø¥ÙŠÙ‚Ø§Ù Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬Ù„Ø³Ø©
          Get-Process powershell -ErrorAction SilentlyContinue | 
              Where-Object { $_.CommandLine -match "monitor-session" } | 
              Stop-Process -Force -ErrorAction SilentlyContinue
          
          # ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
          $endInfo = @{
              EndTime = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
              SessionID = $env:SESSION_ID
              Reason = "Manual shutdown or timeout"
          } | ConvertTo-Json
          
          Add-Content -Path "C:\RDP-Session\session-info.json" -Value "`n$endInfo"
          
          # ØªØ¹Ø·ÙŠÙ„ RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 1 -Force
          
          # Ø­Ø°Ù Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ
          netsh advfirewall firewall delete rule name="GitHub-RDP-Infinite" 2>$null
          netsh advfirewall firewall delete rule name="GitHub-SSH-Infinite" 2>$null
          netsh advfirewall firewall delete rule name="Block-Public-RDP" 2>$null
          
          # Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Tailscale
          & "$env:ProgramFiles\Tailscale\tailscale.exe" logout 2>$null
          
          # Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
          # Remove-LocalUser -Name $env:RDP_USERNAME -ErrorAction SilentlyContinue
          
          Write-Host "âœ… Cleanup completed"
          Write-Host "Session logs saved in: C:\RDP-Session\"
